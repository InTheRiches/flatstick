// import fs from "fs";
// import path from "path";

// Utility: load CSV as grid points
async function loadGreenData(holeNumber) {
    const content = "Easting,Northing,Elevation\n" +
        "-85.62307726647686,42.20865466647684,270.459136963\n" +
        "-85.62304799943054,42.20865466647684,270.319122314\n" +
        "-85.62301873238422,42.20865466647684,270.532928467\n" +
        "-85.62298946533791,42.20865466647684,270.612915039\n" +
        "-85.6229601982916,42.20865466647684,270.452911377\n" +
        "-85.62293093124528,42.20865466647684,270.452911377\n" +
        "-85.62290166419896,42.20865466647684,270.492218018\n" +
        "-85.62287239715265,42.20865466647684,270.512207031\n" +
        "-85.62284313010633,42.20865466647684,270.552215576\n" +
        "-85.62281386306002,42.20865466647684,270.573242188\n" +
        "-85.6227845960137,42.20865466647684,270.673248291\n" +
        "-85.62275532896739,42.20865466647684,271.013244629\n" +
        "-85.62307726647686,42.208625399430524,270.179138184\n" +
        "-85.62304799943054,42.208625399430524,270.259124756\n" +
        "-85.62301873238422,42.208625399430524,270.292938232\n" +
        "-85.62298946533791,42.208625399430524,270.232910156\n" +
        "-85.6229601982916,42.208625399430524,270.312927246\n" +
        "-85.62293093124528,42.208625399430524,270.292938232\n" +
        "-85.62290166419896,42.208625399430524,270.272216797\n" +
        "-85.62287239715265,42.208625399430524,270.232208252\n" +
        "-85.62284313010633,42.208625399430524,270.252227783\n" +
        "-85.62281386306002,42.208625399430524,270.393249512\n" +
        "-85.6227845960137,42.208625399430524,270.573242188\n" +
        "-85.62275532896739,42.208625399430524,270.893249512\n" +
        "-85.62307726647686,42.20859613238421,270.270599365\n" +
        "-85.62304799943054,42.20859613238421,270.230590820\n" +
        "-85.62301873238422,42.20859613238421,270.155090332\n" +
        "-85.62298946533791,42.20859613238421,270.135101318\n" +
        "-85.6229601982916,42.20859613238421,270.135101318\n" +
        "-85.62293093124528,42.20859613238421,270.135101318\n" +
        "-85.62290166419896,42.20859613238421,270.103271484\n" +
        "-85.62287239715265,42.20859613238421,270.103271484\n" +
        "-85.62284313010633,42.20859613238421,270.163269043\n" +
        "-85.62281386306002,42.20859613238421,270.198638916\n" +
        "-85.6227845960137,42.20859613238421,270.398651123\n" +
        "-85.62275532896739,42.20859613238421,270.693237305\n" +
        "-85.62307726647686,42.20856686533789,270.090576172\n" +
        "-85.62304799943054,42.20856686533789,270.030578613\n" +
        "-85.62301873238422,42.20856686533789,270.015106201\n" +
        "-85.62298946533791,42.20856686533789,270.055084229\n" +
        "-85.6229601982916,42.20856686533789,270.095092773\n" +
        "-85.62293093124528,42.20856686533789,270.135101318\n" +
        "-85.62290166419896,42.20856686533789,270.063262939\n" +
        "-85.62287239715265,42.20856686533789,270.023254395\n" +
        "-85.62284313010633,42.20856686533789,270.063262939\n" +
        "-85.62281386306002,42.20856686533789,270.138641357\n" +
        "-85.6227845960137,42.20856686533789,270.378631592\n" +
        "-85.62275532896739,42.20856686533789,270.538635254\n" +
        "-85.62307726647686,42.20853759829158,269.910583496\n" +
        "-85.62304799943054,42.20853759829158,269.910583496\n" +
        "-85.62301873238422,42.20853759829158,269.915100098\n" +
        "-85.62298946533791,42.20853759829158,269.995086670\n" +
        "-85.6229601982916,42.20853759829158,270.055084229\n" +
        "-85.62293093124528,42.20853759829158,270.095092773\n" +
        "-85.62290166419896,42.20853759829158,270.023254395\n" +
        "-85.62287239715265,42.20853759829158,269.983245850\n" +
        "-85.62284313010633,42.20853759829158,270.003265381\n" +
        "-85.62281386306002,42.20853759829158,270.078643799\n" +
        "-85.6227845960137,42.20853759829158,270.198638916\n" +
        "-85.62275532896739,42.20853759829158,270.358642578\n" +
        "-85.62307726647686,42.20850833124526,269.758605957\n" +
        "-85.62304799943054,42.20850833124526,269.758605957\n" +
        "-85.62301873238422,42.20850833124526,269.811431885\n" +
        "-85.62298946533791,42.20850833124526,269.931427002\n" +
        "-85.6229601982916,42.20850833124526,269.951446533\n" +
        "-85.62293093124528,42.20850833124526,269.932861328\n" +
        "-85.62290166419896,42.20850833124526,269.912872314\n" +
        "-85.62287239715265,42.20850833124526,269.912872314\n" +
        "-85.62284313010633,42.20850833124526,269.972869873\n" +
        "-85.62281386306002,42.20850833124526,270.009826660\n" +
        "-85.6227845960137,42.20850833124526,270.129821777\n" +
        "-85.62275532896739,42.20850833124526,270.149841309\n" +
        "-85.62307726647686,42.20847906419895,269.638610840\n" +
        "-85.62304799943054,42.20847906419895,269.738616943\n" +
        "-85.62301873238422,42.20847906419895,269.891418457\n" +
        "-85.62298946533791,42.20847906419895,269.931427002\n" +
        "-85.6229601982916,42.20847906419895,269.851440430\n" +
        "-85.62293093124528,42.20847906419895,269.952880859\n" +
        "-85.62290166419896,42.20847906419895,269.952880859\n" +
        "-85.62287239715265,42.20847906419895,269.872863770\n" +
        "-85.62284313010633,42.20847906419895,269.932861328\n" +
        "-85.62281386306002,42.20847906419895,269.949829102\n" +
        "-85.6227845960137,42.20847906419895,270.069824219\n" +
        "-85.62275532896739,42.20847906419895,270.089843750\n" +
        "-85.62307726647686,42.20844979715264,269.618103027\n" +
        "-85.62304799943054,42.20844979715264,269.758117676\n" +
        "-85.62301873238422,42.20844979715264,269.555023193\n" +
        "-85.62298946533791,42.20844979715264,268.535034180\n" +
        "-85.6229601982916,42.20844979715264,268.415039062\n" +
        "-85.62293093124528,42.20844979715264,268.929443359\n" +
        "-85.62290166419896,42.20844979715264,269.609466553\n" +
        "-85.62287239715265,42.20844979715264,269.949462891\n" +
        "-85.62284313010633,42.20844979715264,269.829467773\n" +
        "-85.62281386306002,42.20844979715264,269.908203125\n" +
        "-85.6227845960137,42.20844979715264,270.008209229\n" +
        "-85.62275532896739,42.20844979715264,270.028228760\n" +
        "-85.62307726647686,42.20865466647684,270.452178955\n" +
        "-85.62304799943054,42.20865466647684,270.632171631\n" +
        "-85.62301873238422,42.20865466647684,270.632171631\n" +
        "-85.62298946533791,42.20865466647684,270.632171631\n" +
        "-85.6229601982916,42.20865466647684,270.592193604\n" +
        "-85.62293093124528,42.20865466647684,270.592193604\n" +
        "-85.62290166419896,42.20865466647684,270.592193604\n" +
        "-85.62287239715265,42.20865466647684,270.612182617\n" +
        "-85.62284313010633,42.20865466647684,270.612182617\n" +
        "-85.62281386306002,42.20865466647684,270.612182617\n" +
        "-85.6227845960137,42.20865466647684,270.612182617\n" +
        "-85.62275532896739,42.20865466647684,271.300689697\n" +
        "-85.62307726647686,42.208625399430524,270.452178955\n" +
        "-85.62304799943054,42.208625399430524,270.632171631\n" +
        "-85.62301873238422,42.208625399430524,270.632171631\n" +
        "-85.62298946533791,42.208625399430524,270.632171631\n" +
        "-85.6229601982916,42.208625399430524,270.592193604\n" +
        "-85.62293093124528,42.208625399430524,270.592193604\n" +
        "-85.62290166419896,42.208625399430524,270.592193604\n" +
        "-85.62287239715265,42.208625399430524,270.612182617\n" +
        "-85.62284313010633,42.208625399430524,270.612182617\n" +
        "-85.62281386306002,42.208625399430524,270.612182617\n" +
        "-85.6227845960137,42.208625399430524,270.612182617\n" +
        "-85.62275532896739,42.208625399430524,271.300689697\n" +
        "-85.62307726647686,42.20859613238421,270.152191162\n" +
        "-85.62304799943054,42.20859613238421,270.052185059\n" +
        "-85.62301873238422,42.20859613238421,270.052185059\n" +
        "-85.62298946533791,42.20859613238421,270.052185059\n" +
        "-85.6229601982916,42.20859613238421,270.132171631\n" +
        "-85.62293093124528,42.20859613238421,270.132171631\n" +
        "-85.62290166419896,42.20859613238421,270.132171631\n" +
        "-85.62287239715265,42.20859613238421,270.132171631\n" +
        "-85.62284313010633,42.20859613238421,270.132171631\n" +
        "-85.62281386306002,42.20859613238421,270.132171631\n" +
        "-85.6227845960137,42.20859613238421,270.132171631\n" +
        "-85.62275532896739,42.20859613238421,270.620697021\n" +
        "-85.62307726647686,42.20856686533789,270.152191162\n" +
        "-85.62304799943054,42.20856686533789,270.052185059\n" +
        "-85.62301873238422,42.20856686533789,270.052185059\n" +
        "-85.62298946533791,42.20856686533789,270.052185059\n" +
        "-85.6229601982916,42.20856686533789,270.132171631\n" +
        "-85.62293093124528,42.20856686533789,270.132171631\n" +
        "-85.62290166419896,42.20856686533789,270.132171631\n" +
        "-85.62287239715265,42.20856686533789,270.132171631\n" +
        "-85.62284313010633,42.20856686533789,270.132171631\n" +
        "-85.62281386306002,42.20856686533789,270.132171631\n" +
        "-85.6227845960137,42.20856686533789,270.132171631\n" +
        "-85.62275532896739,42.20856686533789,270.620697021\n" +
        "-85.62307726647686,42.20853759829158,270.152191162\n" +
        "-85.62304799943054,42.20853759829158,270.052185059\n" +
        "-85.62301873238422,42.20853759829158,270.052185059\n" +
        "-85.62298946533791,42.20853759829158,270.052185059\n" +
        "-85.6229601982916,42.20853759829158,270.132171631\n" +
        "-85.62293093124528,42.20853759829158,270.132171631\n" +
        "-85.62290166419896,42.20853759829158,270.132171631\n" +
        "-85.62287239715265,42.20853759829158,270.132171631\n" +
        "-85.62284313010633,42.20853759829158,270.132171631\n" +
        "-85.62281386306002,42.20853759829158,270.132171631\n" +
        "-85.6227845960137,42.20853759829158,270.132171631\n" +
        "-85.62275532896739,42.20853759829158,270.620697021\n" +
        "-85.62307726647686,42.20850833124526,269.652191162\n" +
        "-85.62304799943054,42.20850833124526,269.912170410\n" +
        "-85.62301873238422,42.20850833124526,269.912170410\n" +
        "-85.62298946533791,42.20850833124526,269.912170410\n" +
        "-85.6229601982916,42.20850833124526,269.992187500\n" +
        "-85.62293093124528,42.20850833124526,269.992187500\n" +
        "-85.62290166419896,42.20850833124526,269.992187500\n" +
        "-85.62287239715265,42.20850833124526,269.952178955\n" +
        "-85.62284313010633,42.20850833124526,269.952178955\n" +
        "-85.62281386306002,42.20850833124526,269.952178955\n" +
        "-85.6227845960137,42.20850833124526,269.952178955\n" +
        "-85.62275532896739,42.20850833124526,270.080688477\n" +
        "-85.62307726647686,42.20847906419895,269.652191162\n" +
        "-85.62304799943054,42.20847906419895,269.912170410\n" +
        "-85.62301873238422,42.20847906419895,269.912170410\n" +
        "-85.62298946533791,42.20847906419895,269.912170410\n" +
        "-85.6229601982916,42.20847906419895,269.992187500\n" +
        "-85.62293093124528,42.20847906419895,269.992187500\n" +
        "-85.62290166419896,42.20847906419895,269.992187500\n" +
        "-85.62287239715265,42.20847906419895,269.952178955\n" +
        "-85.62284313010633,42.20847906419895,269.952178955\n" +
        "-85.62281386306002,42.20847906419895,269.952178955\n" +
        "-85.6227845960137,42.20847906419895,269.952178955\n" +
        "-85.62275532896739,42.20847906419895,270.080688477\n" +
        "-85.62307726647686,42.20844979715264,269.652191162\n" +
        "-85.62304799943054,42.20844979715264,269.912170410\n" +
        "-85.62301873238422,42.20844979715264,269.912170410\n" +
        "-85.62298946533791,42.20844979715264,269.912170410\n" +
        "-85.6229601982916,42.20844979715264,269.992187500\n" +
        "-85.62293093124528,42.20844979715264,269.992187500\n" +
        "-85.62290166419896,42.20844979715264,269.992187500\n" +
        "-85.62287239715265,42.20844979715264,269.952178955\n" +
        "-85.62284313010633,42.20844979715264,269.952178955\n" +
        "-85.62281386306002,42.20844979715264,269.952178955\n" +
        "-85.6227845960137,42.20844979715264,269.952178955\n" +
        "-85.62275532896739,42.20844979715264,270.080688477\n" +
        "-85.62307726647686,42.20865466647684,270.348083496\n" +
        "-85.62304799943054,42.20865466647684,270.448089600\n" +
        "-85.62301873238422,42.20865466647684,270.448089600\n" +
        "-85.62298946533791,42.20865466647684,270.448089600\n" +
        "-85.6229601982916,42.20865466647684,270.448089600\n" +
        "-85.62293093124528,42.20865466647684,270.448089600\n" +
        "-85.62290166419896,42.20865466647684,270.448089600\n" +
        "-85.62287239715265,42.20865466647684,270.448089600\n" +
        "-85.62284313010633,42.20865466647684,270.448089600\n" +
        "-85.62281386306002,42.20865466647684,270.448089600\n" +
        "-85.6227845960137,42.20865466647684,270.448089600\n" +
        "-85.62275532896739,42.20865466647684,272.648071289\n" +
        "-85.62307726647686,42.208625399430524,270.348083496\n" +
        "-85.62304799943054,42.208625399430524,270.448089600\n" +
        "-85.62301873238422,42.208625399430524,270.448089600\n" +
        "-85.62298946533791,42.208625399430524,270.448089600\n" +
        "-85.6229601982916,42.208625399430524,270.448089600\n" +
        "-85.62293093124528,42.208625399430524,270.448089600\n" +
        "-85.62290166419896,42.208625399430524,270.448089600\n" +
        "-85.62287239715265,42.208625399430524,270.448089600\n" +
        "-85.62284313010633,42.208625399430524,270.448089600\n" +
        "-85.62281386306002,42.208625399430524,270.448089600\n" +
        "-85.6227845960137,42.208625399430524,270.448089600\n" +
        "-85.62275532896739,42.208625399430524,272.648071289\n" +
        "-85.62307726647686,42.20859613238421,269.988098145\n" +
        "-85.62304799943054,42.20859613238421,269.988098145\n" +
        "-85.62301873238422,42.20859613238421,269.988098145\n" +
        "-85.62298946533791,42.20859613238421,269.988098145\n" +
        "-85.6229601982916,42.20859613238421,269.988098145\n" +
        "-85.62293093124528,42.20859613238421,269.988098145\n" +
        "-85.62290166419896,42.20859613238421,269.988098145\n" +
        "-85.62287239715265,42.20859613238421,269.988098145\n" +
        "-85.62284313010633,42.20859613238421,269.988098145\n" +
        "-85.62281386306002,42.20859613238421,269.988098145\n" +
        "-85.6227845960137,42.20859613238421,269.988098145\n" +
        "-85.62275532896739,42.20859613238421,270.128082275\n" +
        "-85.62307726647686,42.20856686533789,269.988098145\n" +
        "-85.62304799943054,42.20856686533789,269.988098145\n" +
        "-85.62301873238422,42.20856686533789,269.988098145\n" +
        "-85.62298946533791,42.20856686533789,269.988098145\n" +
        "-85.6229601982916,42.20856686533789,269.988098145\n" +
        "-85.62293093124528,42.20856686533789,269.988098145\n" +
        "-85.62290166419896,42.20856686533789,269.988098145\n" +
        "-85.62287239715265,42.20856686533789,269.988098145\n" +
        "-85.62284313010633,42.20856686533789,269.988098145\n" +
        "-85.62281386306002,42.20856686533789,269.988098145\n" +
        "-85.6227845960137,42.20856686533789,269.988098145\n" +
        "-85.62275532896739,42.20856686533789,270.128082275\n" +
        "-85.62307726647686,42.20853759829158,269.988098145\n" +
        "-85.62304799943054,42.20853759829158,269.988098145\n" +
        "-85.62301873238422,42.20853759829158,269.988098145\n" +
        "-85.62298946533791,42.20853759829158,269.988098145\n" +
        "-85.6229601982916,42.20853759829158,269.988098145\n" +
        "-85.62293093124528,42.20853759829158,269.988098145\n" +
        "-85.62290166419896,42.20853759829158,269.988098145\n" +
        "-85.62287239715265,42.20853759829158,269.988098145\n" +
        "-85.62284313010633,42.20853759829158,269.988098145\n" +
        "-85.62281386306002,42.20853759829158,269.988098145\n" +
        "-85.6227845960137,42.20853759829158,269.988098145\n" +
        "-85.62275532896739,42.20853759829158,270.128082275\n" +
        "-85.62307726647686,42.20850833124526,269.988098145\n" +
        "-85.62304799943054,42.20850833124526,269.988098145\n" +
        "-85.62301873238422,42.20850833124526,269.988098145\n" +
        "-85.62298946533791,42.20850833124526,269.988098145\n" +
        "-85.6229601982916,42.20850833124526,269.988098145\n" +
        "-85.62293093124528,42.20850833124526,269.988098145\n" +
        "-85.62290166419896,42.20850833124526,269.988098145\n" +
        "-85.62287239715265,42.20850833124526,269.988098145\n" +
        "-85.62284313010633,42.20850833124526,269.988098145\n" +
        "-85.62281386306002,42.20850833124526,269.988098145\n" +
        "-85.6227845960137,42.20850833124526,269.988098145\n" +
        "-85.62275532896739,42.20850833124526,270.128082275\n" +
        "-85.62307726647686,42.20847906419895,269.988098145\n" +
        "-85.62304799943054,42.20847906419895,269.988098145\n" +
        "-85.62301873238422,42.20847906419895,269.988098145\n" +
        "-85.62298946533791,42.20847906419895,269.988098145\n" +
        "-85.6229601982916,42.20847906419895,269.988098145\n" +
        "-85.62293093124528,42.20847906419895,269.988098145\n" +
        "-85.62290166419896,42.20847906419895,269.988098145\n" +
        "-85.62287239715265,42.20847906419895,269.988098145\n" +
        "-85.62284313010633,42.20847906419895,269.988098145\n" +
        "-85.62281386306002,42.20847906419895,269.988098145\n" +
        "-85.6227845960137,42.20847906419895,269.988098145\n" +
        "-85.62275532896739,42.20847906419895,270.128082275\n" +
        "-85.62307726647686,42.20844979715264,269.988098145\n" +
        "-85.62304799943054,42.20844979715264,269.988098145\n" +
        "-85.62301873238422,42.20844979715264,269.988098145\n" +
        "-85.62298946533791,42.20844979715264,269.988098145\n" +
        "-85.6229601982916,42.20844979715264,269.988098145\n" +
        "-85.62293093124528,42.20844979715264,269.988098145\n" +
        "-85.62290166419896,42.20844979715264,269.988098145\n" +
        "-85.62287239715265,42.20844979715264,269.988098145\n" +
        "-85.62284313010633,42.20844979715264,269.988098145\n" +
        "-85.62281386306002,42.20844979715264,269.988098145\n" +
        "-85.6227845960137,42.20844979715264,269.988098145\n" +
        "-85.62275532896739,42.20844979715264,270.128082275"

    // Split the data into lines, then remove the header row.
    const lines = content.trim().split('\n').slice(1);


    // Filter out any null entries from invalid lines
    return lines.map(line => {
        // Some data points have non-numeric characters, clean them up before parsing
        const cleanedLine = line.replace(/[^\d.,-]/g, '');
        const [easting, northing, elevation] = cleanedLine.split(',');

        // Convert to numbers. The coordinates are lon/lat, so we swap them for Leaflet's lat/lon format.
        const lon = parseFloat(easting);
        const lat = parseFloat(northing);
        const elev = parseFloat(elevation);

        // Ensure all values are valid numbers before returning
        if (!isNaN(lat) && !isNaN(lon) && !isNaN(elev)) {
            return {y: lat, x: lon, z: elev}; // Return as object for easier access
        }
        return null; // Return null for invalid lines
    }).filter(p => p !== null);
}

/**
 * Performs bilinear interpolation on a regularly spaced, but potentially non-square, grid of points.
 * @param {number} x The x-coordinate of the point to interpolate.
 * @param {number} y The y-coordinate of the point to interpolate.
 * @param {Array<{x: number, y: number, z: number}>} grid The grid data, sorted first by y, then by x.
 * @returns {number} The interpolated z-value (elevation).
 */
function getElevationBilinear(x, y, grid) {
    // --- 1. Basic validation and grid dimension calculation ---
    if (!grid || grid.length < 4) {
        // Need at least a 2x2 grid to interpolate.
        return grid?.[0]?.z ?? 0;
    }

    const firstY = grid[0].location.y;
    const width = grid.findIndex(p => p.location.y !== firstY);
    // If all points are on the same line, findIndex returns -1.
    if (width === -1) return grid[0].value;

    const height = grid.length / width;
    if (!Number.isInteger(height)) {
        // Grid is not rectangular, cannot interpolate reliably.
        console.error("Grid is not rectangular.");
        return grid[0].value;
    }

    // --- 2. Calculate grid spacing and origin ---
    const xOrigin = grid[0].location.x;
    const yOrigin = grid[0].location.y;
    const xSpacing = grid[1].location.x - xOrigin;
    const ySpacing = grid[width].location.y - yOrigin;

    // --- 3. Calculate fractional position in the grid (without clamping yet) ---
    const col = (x - xOrigin) / xSpacing;
    const row = (y - yOrigin) / ySpacing;

    // --- 4. Get integer indices of the top-left corner of the cell ---
    let i = Math.floor(col);
    let j = Math.floor(row);

    // --- 5. Get the fractional parts (interpolation weights) ---
    const u = col - i; // x-component (horizontal weight)
    const v = row - j; // y-component (vertical weight)

    // --- 6. Clamp indices to be within the valid grid bounds ---
    // This ensures we can always fetch four points.
    i = Math.max(0, Math.min(i, width - 2));
    j = Math.max(0, Math.min(j, height - 2));

    // --- 7. Fetch the four surrounding points (the 2x2 cell) ---
    //  (i, j)   ---   (i+1, j)
    //    |              |
    // (i, j+1)  ---  (i+1, j+1)
    const z00 = grid[j * width + i].z;       // Top-left
    const z10 = grid[j * width + (i + 1)].z;     // Top-right
    const z01 = grid[(j + 1) * width + i].z;   // Bottom-left
    const z11 = grid[(j + 1) * width + (i + 1)].z; // Bottom-right

    // --- 8. Perform the interpolation ---
    // Interpolate horizontally along the top edge of the cell
    const zTop = z00 * (1 - u) + z10 * u;

    // Interpolate horizontally along the bottom edge of the cell
    const zBottom = z01 * (1 - u) + z11 * u;

    console.log(`Interpolating between (${zTop}, ${zBottom}):`);

    // Interpolate vertically between the two horizontal results
    return zTop * (1 - v) + zBottom * v;
}
const METERS_PER_DEGREE = 111320; // Approximate conversion for latitude

/**
 * Correctly computes the slope vector (gradient) at a point using meters.
 * @param {number} x - Longitude of the point.
 * @param {number} y - Latitude of the point.
 * @param {Array} grid - The elevation grid data.
 * @param {number} h_meters - The step distance for finite difference, in meters.
 * @returns {{dx: number, dy: number}} The gradient as a unitless slope (m/m).
 */
function getGradient(x, y, grid, h_meters = 0.01) { // Use a small step, e.g., 1 cm
    const lat_rad = y * (Math.PI / 180);

    // Convert step from meters to degrees for both longitude and latitude
    const h_lat = h_meters / METERS_PER_DEGREE;
    const h_lon = h_meters / (METERS_PER_DEGREE * Math.cos(lat_rad));

    // elevations at points +/- h meters away
    const zx1 = getElevationBilinear(x + h_lon, y, grid);
    const zx2 = getElevationBilinear(x - h_lon, y, grid);
    const zy1 = getElevationBilinear(x, y + h_lat, grid);
    const zy2 = getElevationBilinear(x, y - h_lat, grid);

    // Calculate slope (dz / dx) in meters/meters
    const dx = (zx1 - zx2) / (2 * h_meters);
    const dy = (zy1 - zy2) / (2 * h_meters);

    return { dx, dy };
}

/**
 * Predicts the putt's break in inches based on green topography.
 * @param lidarGrid
 * @param {{latitude: number, longitude: number}} tap - The ball's position.
 * @param {{latitude: number, longitude: number}} pin - The pin's position.
 * @param {number} stimp - The Stimp rating of the green (e.g., 10 for medium speed).
 * @returns {Promise<object>} An object with putt details, including the break in inches.
 */
export async function predictPutt(lidarGrid, tap, pin, stimp = 10) {
    const grid = lidarGrid

    // --- 1. Calculate Distances and Elevations ---
    const dx_deg = pin.longitude - tap.longitude;
    const dy_deg = pin.latitude - tap.latitude;
    const lat_rad_mid = ((tap.latitude + pin.latitude) / 2) * (Math.PI / 180);

    // Convert degree distances to meters
    const dx_m = dx_deg * METERS_PER_DEGREE * Math.cos(lat_rad_mid);
    const dy_m = dy_deg * METERS_PER_DEGREE;

    const flatDistMeters = Math.sqrt(dx_m**2 + dy_m**2);
    const flatDistFeet = flatDistMeters * 3.28084;

    const zTap = getElevationBilinear(tap.longitude, tap.latitude, grid);
    const zPin = getElevationBilinear(pin.longitude, pin.latitude, grid);
    const dz_m = zPin - zTap; // Elevation change in meters

    // --- 2. Calculate Side Slope at Midpoint ---
    const mid = {
        x: (tap.longitude + pin.longitude) / 2,
        y: (tap.latitude + pin.latitude) / 2
    };
    const grad = getGradient(mid.x, mid.y, grid); // grad is {dx, dy} slope in m/m

    // Normalized putt direction vector
    const puttDir = { x: dx_m / flatDistMeters, y: dy_m / flatDistMeters };

    // The side slope is the component of the gradient perpendicular to the putt line.
    // This is found using the dot product.
    const sideSlope = grad.dx * -puttDir.y + grad.dy * puttDir.x;
    const sideSlopePercent = sideSlope * 100;

    // --- 3. Calculate Break in Inches ---
    // This is a well-established approximation formula.
    // The constant adjusts for a standard green speed (e.g., Stimp 10).
    const GREEN_SPEED_CONSTANT = 0.15; // Adjust this based on real-world results
    const breakInches = sideSlopePercent * flatDistFeet * (stimp / 10) * GREEN_SPEED_CONSTANT;

    // --- 4. Determine Break Direction ---
    // A positive sideSlope means the ground is higher on the right, so the ball breaks left.
    const breakDirection = breakInches > 0 ? 'Left' : 'Right';

    return {
        puttDistanceFeet: flatDistFeet,
        elevationChangeInches: dz_m * 39.3701,
        slopePercent: (dz_m / flatDistMeters) * 100,
        sideSlopePercent: Math.abs(sideSlopePercent),
        aimingBreakInches: Math.abs(breakInches),
        breakDirection: breakDirection,
    };
}
